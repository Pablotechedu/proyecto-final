rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function para verificar si es una Service Account
    function isServiceAccount() {
      return request.auth != null && 
             request.auth.token.email != null &&
             request.auth.token.email.matches('.*@.*\\.iam\\.gserviceaccount\\.com$');
    }
    
    // Helper function para obtener datos del usuario
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function para obtener el rol del usuario
    function getUserRole() {
      return getUserData().role;
    }
    
    // Helper function para verificar si es director
    function isDirector() {
      return isAuthenticated() && getUserData().isDirector == true;
    }
    
    // Helper function para verificar si es admin
    function isAdmin() {
      return isAuthenticated() && (getUserRole() == 'admin' || isDirector());
    }
    
    // Helper function para verificar si es admin o editor
    function isAdminOrEditor() {
      return isAuthenticated() && (getUserRole() == 'admin' || getUserRole() == 'editor' || isDirector());
    }
    
    // Colección: users
    match /users/{userId} {
      allow read: if isAuthenticated() || isServiceAccount();
      allow write: if isAdmin() || isServiceAccount();
    }
    
    // Colección: patients
    match /patients/{patientId} {
      allow read: if isAuthenticated() || isServiceAccount();
      allow write: if isAdminOrEditor() || isServiceAccount();
      
      // Subcollection: parentTutors
      match /parentTutors/{parentId} {
        allow read: if isAuthenticated() || isServiceAccount();
        allow write: if isAdminOrEditor() || isServiceAccount();
      }
      
      // Subcollection: relatedProfessionals
      match /relatedProfessionals/{professionalId} {
        allow read: if isAuthenticated() || isServiceAccount();
        allow write: if isAdminOrEditor() || isServiceAccount();
      }
    }
    
    // Colección: sessions
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() || isServiceAccount();
      allow create: if isAuthenticated() || isServiceAccount();
      allow update: if isAuthenticated() || isServiceAccount();
      allow delete: if isAdminOrEditor() || isServiceAccount();
    }
    
    // Colección: payments
    match /payments/{paymentId} {
      allow read: if isAuthenticated() || isServiceAccount();
      allow write: if isAdminOrEditor() || isServiceAccount();
    }
    
    // Colección: expenses
    match /expenses/{expenseId} {
      allow read: if isAdmin() || isServiceAccount();
      allow write: if isAdmin() || isServiceAccount();
    }
    
    // Colección: payrolls
    match /payrolls/{payrollId} {
      allow read: if isAdmin() || isServiceAccount();
      allow write: if isAdmin() || isServiceAccount();
    }
    
    // Colección: formTemplates
    match /formTemplates/{templateId} {
      allow read: if isAuthenticated() || isServiceAccount();
      allow write: if isAdmin() || isServiceAccount();
    }
  }
}
